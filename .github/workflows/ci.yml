name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Install Zig 0.15.2
      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      # 2. Install NATS Server 2.12.3
      - name: Install NATS Server
        run: |
          curl -L https://github.com/nats-io/nats-server/releases/download/v2.12.3/nats-server-v2.12.3-linux-amd64.tar.gz -o nats.tar.gz
          tar -xzf nats.tar.gz
          sudo mv nats-server-v2.12.3-linux-amd64/nats-server /usr/local/bin/
          nats-server --version

      # 3. Build the Project (Ensures compilation works before tests)
      - name: Build
        run: zig build


      # Token Auth
      - name: Test Token Auth
        env:
          NATS_TOKEN: test_token_12345
        run: |
          # Start NATS in background with token config (port 4223)
          nats-server -c int-test/nats-token.conf &
          SERVER_PID=$!

          # Wait for server to be ready
          sleep 2

          # Run the integration test
          zig build integration-test --summary all

          # Kill the server
          kill $SERVER_PID || true

      # User/Pass Auth
      - name: Test User/Pass Auth
        env:
          NATS_USER: testuser
          NATS_PASS: testpass
        run: |
          # Start NATS in background with user/pass config (port 4224)
          nats-server -c int-test/nats-userpass.conf &
          SERVER_PID=$!
          sleep 2

          zig build integration-test --summary all

          # Kill the server
          kill $SERVER_PID || true

      # NKey Auth
      - name: Test NKey Auth
        env:
          NATS_NKEY_SEED: SUAEBVUWOAJRL5FSDXP3A7EEUC3ZU7GYILW6TMVK2J63RQAZQQ642MVIBI
        run: |
          # Start server with NKey config (port 4225)
          nats-server -c int-test/nats-nkey.conf &
          SERVER_PID=$!
          sleep 2

          # Run test with the seed that matches the public key in config
          zig build integration-test --summary all

          # Kill the server
          kill $SERVER_PID || true


      # JWT / Operator Auth
      - name: Test JWT Auth
        run: |
          # 1. Install nsc (Tool to generate NATS JWTs)
          curl -L https://github.com/nats-io/nsc/releases/download/v2.10.2/nsc-linux-amd64.zip -o nsc.zip
          unzip nsc.zip
          sudo mv nsc /usr/local/bin/

          # 2. Setup PKI (Operator -> Account)
          # Initialize a new Operator and Account locally
          nsc init -n CI_OP --dir ./nsc_store
          nsc add account -n CI_ACC
          
          # 3. Generate Server Config
          # --mem-resolver embeds the Account JWT directly into the config file.
          # This allows the server to validate users without needing an external URL/server.
          nsc generate config --mem-resolver --config-file ./nsc_store/resolver.conf

          # 4. Create a User Dynamically
          # We mint a new user signed by the CI_ACC account
          nsc add user -n CI_USER
          nsc generate creds -a CI_ACC -n CI_USER > user.creds

          # 5. Extract Credentials
          # The .creds file contains the JWT (starts with 'eyJ') and the Seed (starts with 'S')
          # We parse them out to pass as environment variables
          JWT_VAL=$(grep -v '\-\-\-' user.creds | grep 'eyJ')
          SEED_VAL=$(grep -v '\-\-\-' user.creds | grep '^S')

          # 6. Start Server & Run Test
          # Start NATS with the generated resolver config (Port 4226)
          nats-server -c ./nsc_store/resolver.conf -p 4226 &
          SERVER_PID=$!
          sleep 2

          # Run the test passing the extracted credentials
          NATS_JWT="$JWT_VAL" NATS_NKEY_SEED="$SEED_VAL" zig build integration-test --summary all

          kill $SERVER_PID || true

      # Run Unit Tests without NATS server
      # mem leaks removed & ConnError handled
      - name: Run Unit Tests without NATS Server
        run: zig build test --summary all

      # Run Unit Tests with NATS server
      - name: Run Unit Tests with NATS Server
        run: |
          # Start NATS in background with JetStream enabled (port 4222)
          nats-server -js -p 4222 &
          SERVER_PID=$!
          sleep 2

          zig build test --summary all

          # Kill the server
          kill $SERVER_PID || true
      
      # TLS Upgrade
      - name: Test TLS Upgrade
        run: |
          # 1. Create directory if it doesn't exist
          mkdir -p int-test

          # 2. Generate Self-Signed Certificates (so we don't need them in Git)
          # We generate them exactly where the test expects: ./int-test/
          openssl req -x509 -newkey rsa:4096 -sha256 -days 365 -nodes \
            -keyout int-test/localhost+2-key.pem \
            -out int-test/localhost+2.pem \
            -subj "/CN=localhost" \
            -addext "subjectAltName=DNS:localhost,IP:127.0.0.1"

          # 3. Start NATS with TLS (Port 4222)
          # We use the generated keys from int-test/
          nats-server --tls --tlscert=int-test/localhost+2.pem --tlskey=int-test/localhost+2-key.pem -DV -p 4222 &
          SERVER_PID=$!
          
          # Give the server a moment to initialize TLS
          sleep 2

          # 4. Run the TLS test
          zig build tls

          # 5. Cleanup
          kill $SERVER_PID || true